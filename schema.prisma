generator client {
  provider      = "prisma-client-js"
  output        = "./node_modules/.prisma/client"
  binaryTargets = ["native", "linux-musl", "linux-musl-openssl-3.0.x", "linux-musl-arm64-openssl-3.0.x", "darwin", "darwin-arm64"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                String  @id
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  User              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Analytics {
  id         String          @id
  entityType EntityType
  entityId   String
  period     AnalyticsPeriod
  metrics    String
  createdAt  DateTime        @default(now())
  updatedAt  DateTime

  @@unique([entityType, entityId, period])
}

model Connection {
  id                                             String       @id
  sourceId                                       String
  targetId                                       String
  condition                                      String?
  WorkflowNode_Connection_sourceIdToWorkflowNode WorkflowNode @relation("Connection_sourceIdToWorkflowNode", fields: [sourceId], references: [id], onDelete: Cascade)
  WorkflowNode_Connection_targetIdToWorkflowNode WorkflowNode @relation("Connection_targetIdToWorkflowNode", fields: [targetId], references: [id], onDelete: Cascade)

  @@unique([sourceId, targetId])
}

model Contact {
  id               String             @id
  email            String?
  phone            String?
  firstName        String?
  lastName         String?
  company          String?
  jobTitle         String?
  address          String?
  city             String?
  state            String?
  country          String?
  postalCode       String?
  notes            String?
  tagsString       String?
  source           String?
  status           ContactStatus      @default(ACTIVE)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime
  createdById      String
  createdBy        User               @relation("UserToContact", fields: [createdById], references: [id])
  EmailActivity    EmailActivity[]
  ListMember       ListMember[]
  SMSActivity      SMSActivity[]
  WhatsAppActivity WhatsAppActivity[]
  ContactJourney   ContactJourney[]
}

model EmailActivity {
  id            String        @id
  campaignId    String
  contactId     String
  type          ActivityType
  timestamp     DateTime      @default(now())
  metadata      String?
  EmailCampaign EmailCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  Contact       Contact       @relation(fields: [contactId], references: [id], onDelete: Cascade)
}

model EmailCampaign {
  id            String          @id
  name          String
  description   String?
  subject       String
  from          String
  replyTo       String?
  templateId    String?
  content       String?
  design        String?
  status        CampaignStatus  @default(DRAFT)
  scheduledFor  DateTime?
  sentAt        DateTime?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime
  createdById   String
  EmailActivity EmailActivity[]
  createdBy     User            @relation("UserToEmailCampaign", fields: [createdById], references: [id])
  EmailTemplate EmailTemplate?  @relation(fields: [templateId], references: [id])
  List          List[]          @relation("CampaignLists")
  Segment       Segment[]       @relation("CampaignSegments")
}

model EmailTemplate {
  id            String          @id
  name          String
  description   String?
  subject       String
  content       String
  design        String?
  previewText   String?
  category      String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime
  createdById   String
  EmailCampaign EmailCampaign[]
  createdBy     User            @relation("UserToEmailTemplate", fields: [createdById], references: [id])
}

model IntegrationConnection {
  id        String           @id
  name      String
  type      IntegrationType
  config    String
  status    ConnectionStatus @default(INACTIVE)
  createdAt DateTime         @default(now())
  updatedAt DateTime
}

model List {
  id               String             @id
  name             String
  description      String?
  type             ListType           @default(STATIC)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime
  createdById      String
  createdBy        User               @relation("UserToList", fields: [createdById], references: [id])
  ListMember       ListMember[]
  EmailCampaign    EmailCampaign[]    @relation("CampaignLists")
  SMSCampaign      SMSCampaign[]      @relation("SMSCampaignLists")
  WhatsAppCampaign WhatsAppCampaign[] @relation("WACampaignLists")
}

model ListMember {
  id        String   @id
  listId    String
  contactId String
  addedAt   DateTime @default(now())
  Contact   Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  List      List     @relation(fields: [listId], references: [id], onDelete: Cascade)

  @@unique([listId, contactId])
}

model SMSActivity {
  id          String       @id
  campaignId  String
  contactId   String
  type        ActivityType
  timestamp   DateTime     @default(now())
  metadata    String?
  SMSCampaign SMSCampaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  Contact     Contact      @relation(fields: [contactId], references: [id], onDelete: Cascade)
}

model SMSCampaign {
  id           String         @id
  name         String
  description  String?
  from         String
  templateId   String?
  content      String?
  status       CampaignStatus @default(DRAFT)
  scheduledFor DateTime?
  sentAt       DateTime?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime
  createdById  String
  SMSActivity  SMSActivity[]
  createdBy    User           @relation("UserToSMSCampaign", fields: [createdById], references: [id])
  SMSTemplate  SMSTemplate?   @relation(fields: [templateId], references: [id])
  List         List[]         @relation("SMSCampaignLists")
  Segment      Segment[]      @relation("SMSCampaignSegments")
}

model SMSTemplate {
  id          String        @id
  name        String
  content     String
  variables   String
  category    String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime
  createdById String
  SMSCampaign SMSCampaign[]
  createdBy   User          @relation("UserToSMSTemplate", fields: [createdById], references: [id])
}

model Segment {
  id               String             @id
  name             String
  description      String?
  rules            String
  createdAt        DateTime           @default(now())
  updatedAt        DateTime
  createdById      String
  createdBy        User               @relation("UserToSegment", fields: [createdById], references: [id])
  EmailCampaign    EmailCampaign[]    @relation("CampaignSegments")
  SMSCampaign      SMSCampaign[]      @relation("SMSCampaignSegments")
  WhatsAppCampaign WhatsAppCampaign[] @relation("WACampaignSegments")
}

model Session {
  id           String   @id
  sessionToken String   @unique
  userId       String
  expires      DateTime
  User         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id               String             @id @default(cuid())
  name             String?
  email            String             @unique
  emailVerified    DateTime?
  password         String?
  image            String?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  lastLogin        DateTime?
  isActive         Boolean            @default(true)
  role             UserRole           @default(USER)
  company          String?
  Account          Account[]
  Contact          Contact[]          @relation("UserToContact")
  EmailCampaign    EmailCampaign[]    @relation("UserToEmailCampaign")
  EmailTemplate    EmailTemplate[]    @relation("UserToEmailTemplate")
  List             List[]             @relation("UserToList")
  SMSCampaign      SMSCampaign[]      @relation("UserToSMSCampaign")
  SMSTemplate      SMSTemplate[]      @relation("UserToSMSTemplate")
  Segment          Segment[]          @relation("UserToSegment")
  Session          Session[]
  preference       UserPreference?    @relation("UserToPreference")
  WhatsAppCampaign WhatsAppCampaign[] @relation("UserToWhatsAppCampaign")
  WhatsAppTemplate WhatsAppTemplate[] @relation("UserToWhatsAppTemplate")
  Workflow         Workflow[]         @relation("UserToWorkflow")
  Journey          Journey[]
  // LeadPulse Relations
  LeadPulseForms       LeadPulseForm[]       @relation("UserToLeadPulseForm")
  LeadPulseWebhooks    LeadPulseWebhook[]    @relation("UserToLeadPulseWebhook")
  LeadPulseConfigs     LeadPulseConfig[]     @relation("UserToLeadPulseConfig")
  LeadPulseWhatsAppQRs LeadPulseWhatsAppQR[] @relation("UserToLeadPulseWhatsAppQR")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model WhatsAppActivity {
  id               String           @id
  campaignId       String
  contactId        String
  type             ActivityType
  timestamp        DateTime         @default(now())
  metadata         String?
  WhatsAppCampaign WhatsAppCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  Contact          Contact          @relation(fields: [contactId], references: [id], onDelete: Cascade)
}

model WhatsAppCampaign {
  id               String             @id
  name             String
  description      String?
  from             String
  templateId       String?
  content          String?
  status           CampaignStatus     @default(DRAFT)
  scheduledFor     DateTime?
  sentAt           DateTime?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime
  createdById      String
  WhatsAppActivity WhatsAppActivity[]
  createdBy        User               @relation("UserToWhatsAppCampaign", fields: [createdById], references: [id])
  WhatsAppTemplate WhatsAppTemplate?  @relation(fields: [templateId], references: [id])
  List             List[]             @relation("WACampaignLists")
  Segment          Segment[]          @relation("WACampaignSegments")
}

model WhatsAppTemplate {
  id               String             @id
  name             String
  content          String
  variables        String
  category         String?
  status           WATemplateStatus   @default(PENDING)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime
  createdById      String
  WhatsAppCampaign WhatsAppCampaign[]
  createdBy        User               @relation("UserToWhatsAppTemplate", fields: [createdById], references: [id])
}

model Workflow {
  id              String            @id
  name            String
  description     String?
  status          WorkflowStatus    @default(INACTIVE)
  definition      String
  createdAt       DateTime          @default(now())
  updatedAt       DateTime
  createdById     String
  createdBy       User              @relation("UserToWorkflow", fields: [createdById], references: [id])
  WorkflowNode    WorkflowNode[]
  WorkflowTrigger WorkflowTrigger[]
}

model WorkflowNode {
  id                                           String           @id
  workflowId                                   String
  type                                         WorkflowNodeType
  name                                         String?
  config                                       String
  positionX                                    Float?
  positionY                                    Float?
  Connection_Connection_sourceIdToWorkflowNode Connection[]     @relation("Connection_sourceIdToWorkflowNode")
  Connection_Connection_targetIdToWorkflowNode Connection[]     @relation("Connection_targetIdToWorkflowNode")
  Workflow                                     Workflow         @relation(fields: [workflowId], references: [id], onDelete: Cascade)
}

model WorkflowTrigger {
  id         String      @id
  workflowId String
  type       TriggerType
  config     String
  Workflow   Workflow    @relation(fields: [workflowId], references: [id], onDelete: Cascade)
}

model UserPreference {
  id          String   @id @default(cuid())
  userId      String   @unique
  preferences String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation("UserToPreference", fields: [userId], references: [id], onDelete: Cascade)
}

model Journey {
  id               String              @id
  name             String
  description      String?
  isActive         Boolean             @default(true)
  createdById      String
  createdAt        DateTime            @default(now())
  updatedAt        DateTime
  createdBy        User                @relation(fields: [createdById], references: [id])
  JourneyStage     JourneyStage[]
  ContactJourney   ContactJourney[]
  JourneyMetric    JourneyMetric[]
  JourneyAnalytics JourneyAnalytics[]
}

model JourneyStage {
  id                        String                     @id
  journeyId                 String
  name                      String
  description               String?
  order                     Int
  expectedDuration          Int?
  conversionGoal            Float?
  isEntryPoint              Boolean                    @default(false)
  isExitPoint               Boolean                    @default(false)
  createdAt                 DateTime                   @default(now())
  updatedAt                 DateTime
  Journey                   Journey                    @relation(fields: [journeyId], references: [id], onDelete: Cascade)
  JourneyTransition_from    JourneyTransition[]        @relation("JourneyTransition_fromStageIdToJourneyStage")
  JourneyTransition_to      JourneyTransition[]        @relation("JourneyTransition_toStageIdToJourneyStage")
  ContactJourney            ContactJourney[]           @relation("ContactJourney_currentStageIdToJourneyStage")
  ContactJourneyStage       ContactJourneyStage[]
  ContactJourneyTransition_from ContactJourneyTransition[] @relation("ContactJourneyTransition_fromStageIdToJourneyStage")
  ContactJourneyTransition_to   ContactJourneyTransition[] @relation("ContactJourneyTransition_toStageIdToJourneyStage")
  JourneyStageMetric        JourneyStageMetric[]
}

model JourneyTransition {
  id                  String                  @id
  fromStageId         String
  toStageId           String
  name                String
  description         String?
  triggerType         String
  triggerDetails      Json?
  conditions          Json?
  createdAt           DateTime                @default(now())
  updatedAt           DateTime
  fromStage           JourneyStage            @relation("JourneyTransition_fromStageIdToJourneyStage", fields: [fromStageId], references: [id], onDelete: Cascade)
  toStage             JourneyStage            @relation("JourneyTransition_toStageIdToJourneyStage", fields: [toStageId], references: [id], onDelete: Cascade)
  ContactJourneyTransition ContactJourneyTransition[]
}

model ContactJourney {
  id                  String                  @id
  contactId           String
  journeyId           String
  currentStageId      String?
  entryDate           DateTime                @default(now())
  lastUpdated         DateTime
  completionDate      DateTime?
  isCompleted         Boolean                 @default(false)
  properties          Json?
  Contact             Contact                 @relation(fields: [contactId], references: [id], onDelete: Cascade)
  Journey             Journey                 @relation(fields: [journeyId], references: [id], onDelete: Cascade)
  currentStage        JourneyStage?           @relation("ContactJourney_currentStageIdToJourneyStage", fields: [currentStageId], references: [id])
  ContactJourneyStage      ContactJourneyStage[]
  ContactJourneyTransition ContactJourneyTransition[]
}

model ContactJourneyStage {
  id               String         @id
  contactJourneyId String
  stageId          String
  entryDate        DateTime       @default(now())
  exitDate         DateTime?
  duration         Int?
  isCompleted      Boolean        @default(false)
  notes            String?
  ContactJourney   ContactJourney @relation(fields: [contactJourneyId], references: [id], onDelete: Cascade)
  JourneyStage     JourneyStage   @relation(fields: [stageId], references: [id], onDelete: Cascade)
}

model ContactJourneyTransition {
  id               String           @id
  contactJourneyId String
  transitionId     String
  fromStageId      String
  toStageId        String
  transitionDate   DateTime         @default(now())
  triggerDetails   Json?
  ContactJourney   ContactJourney   @relation(fields: [contactJourneyId], references: [id], onDelete: Cascade)
  JourneyTransition JourneyTransition @relation(fields: [transitionId], references: [id], onDelete: Cascade)
  fromStage        JourneyStage     @relation("ContactJourneyTransition_fromStageIdToJourneyStage", fields: [fromStageId], references: [id], onDelete: Cascade)
  toStage          JourneyStage     @relation("ContactJourneyTransition_toStageIdToJourneyStage", fields: [toStageId], references: [id], onDelete: Cascade)
}

model JourneyMetric {
  id               String   @id
  journeyId        String
  name             String
  description      String?
  metricType       String
  targetValue      Float?
  aggregationType  String?
  formula          String?
  isSuccess        Boolean  @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime
  Journey          Journey  @relation(fields: [journeyId], references: [id], onDelete: Cascade)
}

model JourneyStageMetric {
  id               String      @id
  stageId          String
  name             String
  description      String?
  metricType       String
  targetValue      Float?
  aggregationType  String?
  formula          String?
  isSuccess        Boolean     @default(false)
  createdAt        DateTime    @default(now())
  updatedAt        DateTime
  JourneyStage     JourneyStage @relation(fields: [stageId], references: [id], onDelete: Cascade)
}

model JourneyAnalytics {
  id                String   @id
  journeyId         String
  date              DateTime
  totalContacts     Int      @default(0)
  stageDistribution Json?
  averageDuration   Int?
  conversionRate    Float?
  dropoffPoints     Json?
  metrics           Json?
  Journey           Journey  @relation(fields: [journeyId], references: [id], onDelete: Cascade)
}

enum ActivityType {
  SENT
  DELIVERED
  OPENED
  CLICKED
  BOUNCED
  UNSUBSCRIBED
  REPLIED
  FAILED
}

enum AnalyticsPeriod {
  DAILY
  WEEKLY
  MONTHLY
  YEARLY
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  PAUSED
  CANCELLED
}

enum ConnectionStatus {
  ACTIVE
  INACTIVE
  ERROR
}

enum ContactStatus {
  ACTIVE
  UNSUBSCRIBED
  BOUNCED
  SPAM
}

enum EntityType {
  EMAIL_CAMPAIGN
  SMS_CAMPAIGN
  WHATSAPP_CAMPAIGN
  WORKFLOW
  LIST
  SEGMENT
}

enum IntegrationType {
  ECOMMERCE_WOOCOMMERCE
  ECOMMERCE_SHOPIFY
  CRM_SALESFORCE
  CRM_HUBSPOT
  PAYMENT_STRIPE
  PAYMENT_PAYPAL
  WEBHOOK
  API
}

enum ListType {
  STATIC
  DYNAMIC
}

enum TriggerType {
  CONTACT_CREATED
  CONTACT_UPDATED
  EMAIL_OPENED
  EMAIL_CLICKED
  FORM_SUBMITTED
  WEBHOOK
  SCHEDULED
}

enum UserRole {
  USER
  ADMIN
  IT_ADMIN
  SUPER_ADMIN
}

enum WATemplateStatus {
  PENDING
  APPROVED
  REJECTED
}

enum WorkflowNodeType {
  TRIGGER
  CONDITION
  ACTION
  DELAY
  EMAIL
  SMS
  WHATSAPP
  NOTIFICATION
  WEBHOOK
}

enum WorkflowStatus {
  ACTIVE
  INACTIVE
  PAUSED
  ARCHIVED
}

// LeadPulse Models
model AnonymousVisitor {
  id                String               @id @default(cuid())
  fingerprint       String               @unique
  firstVisitedAt    DateTime             @default(now())
  lastVisitedAt     DateTime             @updatedAt
  visits            Int                  @default(1)
  conversionStatus  ConversionStatus     @default(ANONYMOUS)
  ipAddress         String?
  country           String?
  region            String?
  city              String?
  device            String?
  browser           String?
  os                String?
  referrer          String?
  utmSource         String?
  utmMedium         String?
  utmCampaign       String?
  contactId         String?              // If converted to a contact
  engagementScore   Float                @default(0)
  metadata          Json?
  LeadPulseTouchpoint LeadPulseTouchpoint[]
  LeadPulseForm       LeadPulseForm[]
  LeadPulseJourney    LeadPulseJourney[]
}

model LeadPulseTouchpoint {
  id                String               @id @default(cuid())
  visitorId         String
  timestamp         DateTime             @default(now())
  pageUrl           String
  pageTitle         String?
  duration          Int?                 // Time spent on page in seconds
  clickData         Json?                // Data about clicks on the page
  scrollDepth       Int?                 // Percentage of page scrolled
  exitIntent        Boolean              @default(false)
  visitor           AnonymousVisitor     @relation(fields: [visitorId], references: [id], onDelete: Cascade)
}

model LeadPulseForm {
  id                String               @id @default(cuid())
  name              String
  description       String?
  formType          FormType             @default(STANDARD)
  fields            Json                 // Form field configuration
  conditionalLogic  Json?                // Rules for showing/hiding fields
  designSettings    Json?                // Visual customization options
  createdById       String
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  isActive          Boolean              @default(true)
  conversionRate    Float?
  submissions       Int                  @default(0)
  views             Int                  @default(0)
  createdBy         User                 @relation("UserToLeadPulseForm", fields: [createdById], references: [id])
  AnonymousVisitor  AnonymousVisitor[]
}

model LeadPulseJourney {
  id                String               @id @default(cuid())
  visitorId         String
  touchpoints       Json                 // Array of touchpoint IDs and metadata
  score             Float                @default(0)
  predictedConversion Float?             // AI-predicted likelihood of conversion
  predictedValue    Float?               // AI-predicted value of the lead
  startedAt         DateTime             @default(now())
  lastActivity      DateTime             @updatedAt
  convertedAt       DateTime?            // When visitor became a contact
  visitor           AnonymousVisitor     @relation(fields: [visitorId], references: [id], onDelete: Cascade)
}

model LeadPulseWebhook {
  id                String               @id @default(cuid())
  name              String
  url               String
  secret            String
  events            String[]             // Array of event types to trigger webhook
  createdById       String
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  isActive          Boolean              @default(true)
  createdBy         User                 @relation("UserToLeadPulseWebhook", fields: [createdById], references: [id])
}

model LeadPulseConfig {
  id                String               @id @default(cuid())
  pixelId           String               @unique
  websiteUrl        String
  websiteName       String?
  createdById       String
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  isActive          Boolean              @default(true)
  settings          Json                 // Configuration settings
  createdBy         User                 @relation("UserToLeadPulseConfig", fields: [createdById], references: [id])
}

model LeadPulseWhatsAppQR {
  id                String               @id @default(cuid())
  name              String
  whatsappNumber    String
  message           String?
  qrCodeUrl         String
  scans             Int                  @default(0)
  createdById       String
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  createdBy         User                 @relation("UserToLeadPulseWhatsAppQR", fields: [createdById], references: [id])
}

enum ConversionStatus {
  ANONYMOUS
  ENGAGED
  QUALIFIED
  CONVERTED
}

enum FormType {
  STANDARD
  EXIT_INTENT
  EMBEDDED
  POPUP
  CHATBOT
  PROGRESSIVE
}
