{"version":3,"sources":["/Users/supreme/Desktop/marketsage/src/lib/ai/rag-engine.ts"],"sourcesContent":["/**\n * RAG (Retrieval-Augmented Generation) Engine\n * ==========================================\n * Enhanced with MarketSage platform expertise\n * Provides intelligent, context-aware responses about MarketSage features\n */\n\nimport { vectorStore, type Document } from './vector-store';\nimport { searchKnowledge } from './marketsage-knowledge-base';\nimport { logger } from '@/lib/logger';\n\nlet summarizer: any = null;\n\n// Initialize summarization model with dynamic import\nasync function getSummarizer() {\n  if (!summarizer) {\n    try {\n      // Dynamic import to prevent loading during build time\n      const { pipeline } = await import('@xenova/transformers');\n      summarizer = await pipeline('summarization', 'Xenova/distilbart-cnn-6-6');\n    } catch (error) {\n      logger.warn('Could not load transformers pipeline, using fallback', error);\n      summarizer = null;\n    }\n  }\n  return summarizer;\n}\n\nexport interface RAGResult {\n  answer: string;\n  contextDocs: Document[];\n  confidence: number;\n}\n\nexport async function ragQuery(question: string, maxDocs = 4): Promise<RAGResult> {\n  try {\n    // Initialize vector store with MarketSage knowledge\n    await vectorStore.initialize();\n    \n    // Search for relevant documents\n    const contextDocs = await vectorStore.search(question, maxDocs);\n    \n    // If no relevant docs found, search knowledge base directly\n    if (contextDocs.length === 0) {\n      const knowledgeResults = searchKnowledge(question);\n      if (knowledgeResults.length > 0) {\n        const firstResult = knowledgeResults[0];\n        return {\n          answer: `Based on MarketSage documentation: ${firstResult.content.slice(0, 500)}...`,\n          contextDocs: [{\n            id: firstResult.id,\n            text: firstResult.content,\n            embedding: [],\n            metadata: { source: 'knowledge-base', category: firstResult.category }\n          }],\n          confidence: 0.7\n        };\n      }\n    }\n\n    // Build context from retrieved documents\n    const context = contextDocs\n      .map(doc => doc.text)\n      .join('\\n\\n');\n\n    // Generate response based on context\n    const answer = await generateAnswerFromContext(question, context);\n    \n    // Calculate confidence based on context relevance\n    const confidence = calculateConfidence(question, contextDocs);\n\n    return {\n      answer,\n      contextDocs,\n      confidence\n    };\n\n  } catch (error) {\n    logger.error('RAG query error:', error);\n    return {\n      answer: generateFallbackResponse(question),\n      contextDocs: [],\n      confidence: 0.3\n    };\n  }\n}\n\nasync function generateAnswerFromContext(question: string, context: string): Promise<string> {\n  try {\n    // If context is very long, summarize it first\n    if (context.length > 2000) {\n      const model = await getSummarizer();\n      \n      if (model) {\n        try {\n          const summary = await model(context, { max_length: 500, min_length: 100 });\n          context = summary[0].summary_text;\n        } catch (error) {\n          logger.warn('Summarization failed, truncating context instead', error);\n          context = context.slice(0, 1500) + '...';\n        }\n      } else {\n        // Fallback: simple truncation\n        context = context.slice(0, 1500) + '...';\n      }\n    }\n\n    // Generate answer based on the question type\n    if (isLeadPulseQuestion(question)) {\n      return generateLeadPulseAnswer(question, context);\n    } else if (isSetupQuestion(question)) {\n      return generateSetupAnswer(question, context);\n    } else if (isTroubleshootingQuestion(question)) {\n      return generateTroubleshootingAnswer(question, context);\n    } else if (isFeaturesQuestion(question)) {\n      return generateFeaturesAnswer(question, context);\n    } else {\n      return generateGeneralAnswer(question, context);\n    }\n\n  } catch (error) {\n    logger.error('Answer generation error:', error);\n    return generateFallbackResponse(question);\n  }\n}\n\nfunction isSetupQuestion(question: string): boolean {\n  const setupKeywords = ['setup', 'configure', 'install', 'connect', 'integrate', 'how to set up'];\n  return setupKeywords.some(keyword => question.toLowerCase().includes(keyword));\n}\n\nfunction isTroubleshootingQuestion(question: string): boolean {\n  const troubleKeywords = ['problem', 'issue', 'error', 'not working', 'failed', 'trouble'];\n  return troubleKeywords.some(keyword => question.toLowerCase().includes(keyword));\n}\n\nfunction isFeaturesQuestion(question: string): boolean {\n  const featureKeywords = ['what is', 'what does', 'features', 'capabilities', 'can I', 'does marketsage'];\n  return featureKeywords.some(keyword => question.toLowerCase().includes(keyword));\n}\n\nfunction isLeadPulseQuestion(question: string): boolean {\n  const leadpulseKeywords = [\n    'leadpulse', 'lead pulse', 'visitor tracking', 'visitor intelligence', \n    'live visitors', 'visitor map', 'visitor analytics', 'visitor behavior',\n    'visitor insights', 'visitor dashboard', 'visitor journey', 'visitor data'\n  ];\n  return leadpulseKeywords.some(keyword => question.toLowerCase().includes(keyword));\n}\n\nfunction generateSetupAnswer(question: string, context: string): string {\n  const steps = extractStepsFromContext(context);\n  if (steps.length > 0) {\n    return `Here's how to set this up in MarketSage:\\n\\n${steps.join('\\n')}\\n\\nFor additional support, you can access the help section in your MarketSage dashboard or contact our support team.`;\n  }\n  \n  return `To set this up in MarketSage, please refer to the configuration section in your dashboard. ${context.slice(0, 300)}... For detailed setup instructions, check Settings → Integrations or contact support for personalized assistance.`;\n}\n\nfunction generateTroubleshootingAnswer(question: string, context: string): string {\n  const solutions = extractSolutionsFromContext(context);\n  if (solutions.length > 0) {\n    return `Here are the recommended solutions:\\n\\n${solutions.join('\\n')}\\n\\nIf these steps don't resolve the issue, please check the system status page or contact MarketSage support with your specific error details.`;\n  }\n  \n  return `For this issue, I recommend checking: 1) Your account settings and permissions, 2) Internet connectivity, 3) Browser cache and cookies. ${context.slice(0, 200)}... If the problem persists, please contact MarketSage support with specific error messages.`;\n}\n\nfunction generateFeaturesAnswer(question: string, context: string): string {\n  return `MarketSage provides comprehensive capabilities for this. ${context.slice(0, 400)}...\\n\\nYou can access this feature through your MarketSage dashboard. For a complete walkthrough, check the AI Intelligence Center or use the in-app help system.`;\n}\n\nfunction generateLeadPulseAnswer(question: string, context: string): string {\n  // Extract LeadPulse-specific features and capabilities from context\n  const features = extractLeadPulseFeatures(context);\n  const apiEndpoints = extractLeadPulseApiInfo(context);\n  \n  let answer = `LeadPulse is MarketSage's advanced visitor intelligence system powered by Supreme AI v3. `;\n  \n  if (question.toLowerCase().includes('dashboard') || question.toLowerCase().includes('interface')) {\n    answer += `The LeadPulse Dashboard provides:\\n\\n• Live Visitor Map with real-time tracking\\n• AI Intelligence insights with Supreme scoring\\n• Journey visualization and conversion analysis\\n• Advanced filtering and segmentation\\n• Export capabilities and automated reporting\\n\\n`;\n  } else if (question.toLowerCase().includes('ai') || question.toLowerCase().includes('intelligence')) {\n    answer += `LeadPulse integrates with Supreme AI v3 for:\\n\\n• Automated business intelligence generation\\n• Visitor behavior prediction (85% accuracy)\\n• Conversion probability scoring\\n• Smart segmentation and recommendations\\n• Real-time anomaly detection\\n\\n`;\n  } else if (question.toLowerCase().includes('api') || question.toLowerCase().includes('integration')) {\n    answer += `LeadPulse API Integration:\\n\\n• /api/leadpulse/ai/intelligence - AI-powered insights\\n• Real-time visitor behavior analysis\\n• Performance predictions and forecasting\\n• Funnel optimization recommendations\\n• Smart segmentation and targeting\\n\\n`;\n  } else if (question.toLowerCase().includes('setup') || question.toLowerCase().includes('install')) {\n    answer += `LeadPulse Setup Process:\\n\\n1. Install tracking script on your website\\n2. Configure visitor scoring parameters\\n3. Set up geographic targeting rules\\n4. Define conversion goals and events\\n5. Create automation triggers\\n6. Monitor dashboard for insights\\n\\n`;\n  } else {\n    answer += `${context.slice(0, 400)}...\\n\\n`;\n  }\n  \n  answer += `Access LeadPulse through Dashboard → LeadPulse or chat with Supreme-AI for personalized assistance with visitor intelligence.`;\n  \n  return answer;\n}\n\nfunction generateGeneralAnswer(question: string, context: string): string {\n  return `Based on MarketSage platform knowledge: ${context.slice(0, 500)}...\\n\\nFor more detailed information, you can explore the relevant section in your MarketSage dashboard or chat with Supreme-AI for personalized guidance.`;\n}\n\nfunction extractStepsFromContext(context: string): string[] {\n  const lines = context.split('\\n');\n  const steps: string[] = [];\n  \n  for (const line of lines) {\n    if (/^\\d+\\./.test(line.trim()) || line.includes('Step ')) {\n      steps.push(`• ${line.trim()}`);\n    }\n  }\n  \n  return steps.slice(0, 10); // Limit to 10 steps\n}\n\nfunction extractSolutionsFromContext(context: string): string[] {\n  const lines = context.split('\\n');\n  const solutions: string[] = [];\n  \n  for (const line of lines) {\n    if (line.includes('- ') && (line.includes('Check') || line.includes('Verify') || line.includes('Review'))) {\n      solutions.push(`• ${line.trim().replace('- ', '')}`);\n    }\n  }\n  \n  return solutions.slice(0, 8); // Limit to 8 solutions\n}\n\nfunction extractLeadPulseFeatures(context: string): string[] {\n  const lines = context.split('\\n');\n  const features: string[] = [];\n  \n  for (const line of lines) {\n    if (line.includes('- ') && (\n      line.includes('tracking') || line.includes('analysis') || \n      line.includes('prediction') || line.includes('intelligence') ||\n      line.includes('segmentation') || line.includes('optimization')\n    )) {\n      features.push(line.trim().replace('- ', ''));\n    }\n  }\n  \n  return features.slice(0, 10);\n}\n\nfunction extractLeadPulseApiInfo(context: string): string[] {\n  const lines = context.split('\\n');\n  const apiInfo: string[] = [];\n  \n  for (const line of lines) {\n    if (line.includes('/api/leadpulse') || line.includes('GET ') || line.includes('POST ')) {\n      apiInfo.push(line.trim());\n    }\n  }\n  \n  return apiInfo.slice(0, 8);\n}\n\nfunction calculateConfidence(question: string, docs: Document[]): number {\n  if (docs.length === 0) return 0.3;\n  \n  let confidence = 0.5; // Base confidence\n  \n  // Boost confidence for MarketSage knowledge docs\n  const hasMarketSageKnowledge = docs.some(doc => \n    doc.metadata?.source === 'marketsage-knowledge'\n  );\n  if (hasMarketSageKnowledge) confidence += 0.3;\n  \n  // Extra boost for LeadPulse-specific knowledge\n  const isLeadPulseQuery = isLeadPulseQuestion(question);\n  const hasLeadPulseKnowledge = docs.some(doc => \n    doc.text.toLowerCase().includes('leadpulse') ||\n    doc.metadata?.category === 'leadpulse'\n  );\n  if (isLeadPulseQuery && hasLeadPulseKnowledge) confidence += 0.2;\n  \n  // Boost for multiple relevant docs\n  if (docs.length >= 3) confidence += 0.1;\n  \n  // Boost for recent docs\n  const hasRecentDocs = docs.some(doc => \n    doc.metadata?.indexed && \n    new Date(doc.metadata.indexed) > new Date(Date.now() - 30 * 24 * 60 * 60 * 1000)\n  );\n  if (hasRecentDocs) confidence += 0.1;\n  \n  return Math.min(confidence, 0.95); // Cap at 95%\n}\n\nfunction generateFallbackResponse(question: string): string {\n  if (isLeadPulseQuestion(question)) {\n    return `I'd be happy to help you with LeadPulse! LeadPulse is MarketSage's advanced visitor intelligence system powered by Supreme AI v3. You can access LeadPulse through Dashboard → LeadPulse to view real-time visitor analytics, AI insights, and conversion predictions. For specific LeadPulse questions, try asking about features, setup, dashboard usage, or API integration.`;\n  }\n  \n  if (question.toLowerCase().includes('marketsage')) {\n    return `I'd be happy to help you with MarketSage! While I'm still processing your specific question, you can find comprehensive information in your MarketSage dashboard under the AI Intelligence Center, or you can access our help documentation. For immediate assistance, try rephrasing your question or contact our support team.`;\n  }\n  \n  return `I'm here to help you with MarketSage! Could you please provide more specific details about what you're looking for? You can ask me about features, setup processes, troubleshooting, or best practices for using MarketSage effectively.`;\n} "],"names":["ragQuery","summarizer","getSummarizer","pipeline","error","logger","warn","question","maxDocs","vectorStore","initialize","contextDocs","search","length","knowledgeResults","searchKnowledge","firstResult","answer","content","slice","id","text","embedding","metadata","source","category","confidence","context","map","doc","join","generateAnswerFromContext","calculateConfidence","generateFallbackResponse","model","summary","max_length","min_length","summary_text","isLeadPulseQuestion","generateLeadPulseAnswer","isSetupQuestion","generateSetupAnswer","isTroubleshootingQuestion","generateTroubleshootingAnswer","isFeaturesQuestion","generateFeaturesAnswer","generateGeneralAnswer","setupKeywords","some","keyword","toLowerCase","includes","troubleKeywords","featureKeywords","leadpulseKeywords","steps","extractStepsFromContext","solutions","extractSolutionsFromContext","features","extractLeadPulseFeatures","apiEndpoints","extractLeadPulseApiInfo","lines","split","line","test","trim","push","replace","apiInfo","docs","hasMarketSageKnowledge","isLeadPulseQuery","hasLeadPulseKnowledge","hasRecentDocs","indexed","Date","now","Math","min"],"mappings":"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"}