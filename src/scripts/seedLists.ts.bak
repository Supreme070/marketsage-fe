import { PrismaClient, ListType } from "@prisma/client";
import * as dotenv from "dotenv";
import { randomUUID } from "crypto";
import { withRetry, createPrismaClientWithRetry, testConnection } from "./utils/db-retry.js";

// Load environment variables
dotenv.config();

// Create Prisma client with retry logic
const prisma = createPrismaClientWithRetry();

// Sample list data
const sampleLists = [
  {
    name: "VIP TESTS",
    description: "VIP Test contacts for email workflow testing - includes Supreme Oye, Kola Olatunde, Anita Oyewumi, Mayowa Ade, MyHomeCulture, and MarketSage Ltd",
    type: ListType.STATIC,
  },
  {
    name: "Nigerian Businesses",
    description: "Business contacts from Nigeria",
    type: ListType.STATIC,
  },
  {
    name: "Individual Customers",
    description: "All individual customer contacts",
    type: ListType.STATIC,
  },
  {
    name: "Marketing Leads",
    description: "Potential leads for marketing campaigns",
    type: ListType.STATIC,
  },
  {
    name: "VIP Contacts",
    description: "High-priority and important contacts",
    type: ListType.STATIC,
  },
  {
    name: "Event Attendees",
    description: "People who attended our events",
    type: ListType.STATIC,
  }
];

async function seedLists() {
  console.log("Starting to seed contact lists...");

  // Test database connection first
  const isConnected = await testConnection(prisma);
  if (!isConnected) {
    throw new Error("Cannot connect to database");
  }

  // Get the first admin user with retry logic
  let adminUser = await withRetry(async () => {
    return await prisma.user.findFirst({
      where: {
        role: "ADMIN",
      },
      select: {
        id: true,
        email: true,
        role: true
      }
    });
  });

  if (!adminUser) {
    adminUser = await withRetry(async () => {
      return await prisma.user.findFirst({
        select: {
          id: true,
          email: true,
          role: true
        }
      });
    });

    if (!adminUser) {
      console.error("No users found in the database. Please create a user first.");
      return;
    }
  }

  console.log(`Using user ${adminUser.email} (${adminUser.id}) as the list creator.`);

  // Create lists
  const createdLists = [];
  for (const listData of sampleLists) {
    try {
      const list = await withRetry(async () => {
        const now = new Date();
        return await prisma.list.create({
          data: {
            id: randomUUID(),
            name: listData.name,
            description: listData.description,
            type: listData.type,
            createdById: adminUser.id,
            createdAt: now,
            updatedAt: now
          },
        });
      });
      createdLists.push(list);
      console.log(`Created list: ${list.name} (${list.id})`);
    } catch (error) {
      console.error(`Error creating list "${listData.name}":`, error);
    }
  }

  if (createdLists.length === 0) {
    console.log("No lists were created. Exiting.");
    await prisma.$disconnect();
    return;
  }

  // Get contacts to add to lists
  const contacts = await prisma.contact.findMany({
    take: 100,
  });

  if (contacts.length === 0) {
    console.log("No contacts found to add to lists.");
    await prisma.$disconnect();
    return;
  }

  console.log(`Found ${contacts.length} contacts to add to lists.`);

  // Add contacts to lists based on criteria
  const memberAssignments = [];

  // Nigerian Businesses list
  const nigerianBusinesses = createdLists.find(list => list.name === "Nigerian Businesses");
  if (nigerianBusinesses) {
    const nigerianCompanyContacts = contacts.filter(
      contact => contact.country === "Nigeria" && contact.company !== null
    );
    
    console.log(`Adding ${nigerianCompanyContacts.length} contacts to Nigerian Businesses list`);
    
    for (const contact of nigerianCompanyContacts) {
      try {
        const member = await prisma.listMember.create({
          data: {
            id: randomUUID(),
            listId: nigerianBusinesses.id,
            contactId: contact.id,
          },
        });
        memberAssignments.push(member);
      } catch (error) {
        console.error(`Error adding contact ${contact.id} to list:`, error);
      }
    }
  }

  // Individual Customers list
  const individualCustomers = createdLists.find(list => list.name === "Individual Customers");
  if (individualCustomers) {
    const individualContacts = contacts.filter(
      contact => (contact.company === null || contact.company === "") && contact.firstName !== null
    ).slice(0, 30); // Limit to 30 contacts
    
    console.log(`Adding ${individualContacts.length} contacts to Individual Customers list`);
    
    for (const contact of individualContacts) {
      try {
        const member = await prisma.listMember.create({
          data: {
            id: randomUUID(),
            listId: individualCustomers.id,
            contactId: contact.id,
          },
        });
        memberAssignments.push(member);
      } catch (error) {
        console.error(`Error adding contact ${contact.id} to list:`, error);
      }
    }
  }

  // Marketing Leads list
  const marketingLeads = createdLists.find(list => list.name === "Marketing Leads");
  if (marketingLeads) {
    // Get every 3rd contact for variety
    const leadContacts = contacts.filter((_, index) => index % 3 === 0).slice(0, 20);
    
    console.log(`Adding ${leadContacts.length} contacts to Marketing Leads list`);
    
    for (const contact of leadContacts) {
      try {
        const member = await prisma.listMember.create({
          data: {
            id: randomUUID(),
            listId: marketingLeads.id,
            contactId: contact.id,
          },
        });
        memberAssignments.push(member);
      } catch (error) {
        console.error(`Error adding contact ${contact.id} to list:`, error);
      }
    }
  }

  // VIP Contacts list
  const vipContacts = createdLists.find(list => list.name === "VIP Contacts");
  if (vipContacts) {
    // Get every 7th contact for variety
    const vipContactsList = contacts.filter((_, index) => index % 7 === 0).slice(0, 10);
    
    console.log(`Adding ${vipContactsList.length} contacts to VIP Contacts list`);
    
    for (const contact of vipContactsList) {
      try {
        const member = await prisma.listMember.create({
          data: {
            id: randomUUID(),
            listId: vipContacts.id,
            contactId: contact.id,
          },
        });
        memberAssignments.push(member);
      } catch (error) {
        console.error(`Error adding contact ${contact.id} to list:`, error);
      }
    }
  }

  // VIP TESTS list - Add specific VIP test contacts
  const vipTestsList = createdLists.find(list => list.name === "VIP TESTS");
  if (vipTestsList) {
    const vipTestEmails = [
      'supremeoye@outlook.com',
      'kolajosph87@gmail.com', 
      'anitaoyewumi@gmail.com',
      'myhomeculture@gmail.com',
      'marketsageltd@gmail.com',
      'adewolemayowa@gmail.com'
    ];
    
    const vipTestContacts = contacts.filter(contact => 
      vipTestEmails.includes(contact.email)
    );
    
    console.log(`Adding ${vipTestContacts.length} VIP test contacts to VIP TESTS list`);
    
    for (const contact of vipTestContacts) {
      try {
        const member = await prisma.listMember.create({
          data: {
            id: randomUUID(),
            listId: vipTestsList.id,
            contactId: contact.id,
          },
        });
        memberAssignments.push(member);
        console.log(`  ✅ Added ${contact.firstName} ${contact.lastName} (${contact.email}) to VIP TESTS`);
      } catch (error) {
        console.error(`Error adding VIP contact ${contact.id} to list:`, error);
      }
    }
    
    if (vipTestContacts.length < vipTestEmails.length) {
      console.log(`⚠️ Only found ${vipTestContacts.length} out of ${vipTestEmails.length} VIP test contacts. Make sure contacts are seeded first.`);
    }
  }

  // Event Attendees list
  const eventAttendees = createdLists.find(list => list.name === "Event Attendees");
  if (eventAttendees) {
    // Get every 5th contact for variety
    const attendeeContacts = contacts.filter((_, index) => index % 5 === 0).slice(0, 15);
    
    console.log(`Adding ${attendeeContacts.length} contacts to Event Attendees list`);
    
    for (const contact of attendeeContacts) {
      try {
        const member = await prisma.listMember.create({
          data: {
            id: randomUUID(),
            listId: eventAttendees.id,
            contactId: contact.id,
          },
        });
        memberAssignments.push(member);
      } catch (error) {
        console.error(`Error adding contact ${contact.id} to list:`, error);
      }
    }
  }

  console.log(`Successfully created ${createdLists.length} lists and added ${memberAssignments.length} members.`);

  await prisma.$disconnect();
}

// Run the seed function
seedLists()
  .catch((error) => {
    console.error("Error running seed script:", error);
    process.exit(1);
  })
  .finally(() => {
    console.log("List seeding complete.");
  }); 